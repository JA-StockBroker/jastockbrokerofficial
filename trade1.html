<script>
  const config = {
    apiKey: "AIzaSyAr63v10I56cCghOTrGV_KhjQ69HnyaP3Q",
    authDomain: "brokerja-74512.firebaseapp.com",
    databaseURL: "https://brokerja-74512-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "brokerja-74512",
    storageBucket: "brokerja-74512.appspot.com",
    messagingSenderId: "1048821297447",
    appId: "1:1048821297447:web:b8a1e2c43b8ed8333b3902"
  };
  firebase.initializeApp(config);
  const db = firebase.database();

  const user = sessionStorage.getItem("username");
  if (!user) location.href = "login.html";
  document.getElementById("usernameDisplay").innerText = user;

  const userRef = db.ref("users/" + user);
  const priceRef = db.ref("market/currentPrice");
  const marketRef = db.ref("market/isOpen");
  const tradesRef = db.ref("users/" + user + "/trades");
  let balance = 0;
  let currentPrice = 1;

  // Live price updates
  priceRef.on("value", snap => {
    currentPrice = parseFloat(snap.val() || 1);
    document.getElementById("livePrice").innerText = currentPrice.toFixed(2);
    updateOpenTrades();
  });

  // Market status
  marketRef.on("value", snap => {
    document.getElementById("marketStatus").innerText = snap.val() ? "✅ Open" : "❌ Closed";
  });

  // Balance
  userRef.child("balance").on("value", snap => {
    balance = parseFloat(snap.val() || 0);
    document.getElementById("balanceDisplay").innerText = balance.toFixed(2);
  });

  // Place trade
  function placeTrade(type) {
    marketRef.once("value", snap => {
      if (!snap.val()) return alert("Market is closed");
      if (balance < 5) return alert("Insufficient balance to trade.");

      const qty = parseInt(document.getElementById("qty").value);
      const tp = parseFloat(document.getElementById("tp").value);
      const sl = parseFloat(document.getElementById("sl").value);
      const entry = currentPrice;

      if (type === 'buy' && (tp <= entry || sl >= entry)) return alert("Invalid TP/SL for Buy");
      if (type === 'sell' && (tp >= entry || sl <= entry)) return alert("Invalid TP/SL for Sell");

      const trade = { type, qty, entry, tp, sl, status: "open", time: Date.now() };
      tradesRef.push(trade);
      userRef.child("balance").set(balance - 1);
      alert("Trade placed ✅");
    });
  }

  // Logout
  function logout() {
    sessionStorage.clear();
    location.href = "login.html";
  }

  // Withdrawal
  function requestWithdrawal() {
    const amount = parseFloat(document.getElementById("withdrawAmt").value);
    const phone = document.getElementById("withdrawPhone").value;
    if (!amount || !phone) return alert("Fill all fields");
    db.ref("users/" + user + "/withdrawalRequests").push({ amount, phone, status: "pending", time: Date.now() });
    alert("Withdrawal will be processed in 2 business days ✅");
  }

  // Update open trades
  function updateOpenTrades() {
    tradesRef.once("value", snap => {
      const data = snap.val() || {};
      const openBox = document.getElementById("openTrades");
      const histBox = document.getElementById("tradeHistory");
      openBox.innerHTML = "";
      histBox.innerHTML = "";
      let wins = 0, losses = 0, total = 0;

      for (let key in data) {
        const t = data[key];
        if (t.status === "closed") {
          total++;
          if (t.pnl > 0) wins++; else losses++;
          histBox.innerHTML += `<div class='trade-card'>${t.type} | Entry: ₹${t.entry} | Qty: ${t.qty}<br>TP: ${t.tp} | SL: ${t.sl}<br>P&L: ₹${t.pnl?.toFixed(2)}</div>`;
          continue;
        }

        let close = false;
        if (t.tp && ((t.type === 'buy' && currentPrice >= t.tp) || (t.type === 'sell' && currentPrice <= t.tp))) close = true;
        if (t.sl && ((t.type === 'buy' && currentPrice <= t.sl) || (t.type === 'sell' && currentPrice >= t.sl))) close = true;

        if (close) {
          const pnl = (t.type === 'buy' ? (currentPrice - t.entry) : (t.entry - currentPrice)) * t.qty;
          tradesRef.child(key).update({ status: "closed", pnl });
          userRef.child("balance").set(balance + pnl);
          continue;
        }

        const pnl = ((t.type === 'buy' ? currentPrice - t.entry : t.entry - currentPrice) * t.qty).toFixed(2);

        openBox.innerHTML += `
          <div class="trade-card">
            ${t.type} | Entry: ₹${t.entry} | Qty: ${t.qty}<br>
            TP: ${t.tp} | SL: ${t.sl}<br>
            Live P&L: ₹${pnl}<br>
            <button onclick="manualClose('${key}', ${pnl})">❌ Close</button>
          </div>
        `;
      }
      document.getElementById("totalTrades").innerText = total;
      document.getElementById("wins").innerText = wins;
      document.getElementById("losses").innerText = losses;
    });
  }

  function manualClose(key, pnl) {
    tradesRef.child(key).update({ status: "closed", pnl });
    userRef.child("balance").set(balance + parseFloat(pnl));
    alert("Trade closed manually ✅");
  }

  // Chart rendering with TP/SL/Entry lines
  function renderChart() {
    const chartRef = db.ref("market/chart");

    chartRef.on("value", snap => {
      const data = snap.val() || {};
      const keys = Object.keys(data).sort();
      const candles = keys.map((k, i) => ({
        x: i, // sequential index instead of timestamp
        y: [
          parseFloat(data[k].open),
          parseFloat(data[k].high),
          parseFloat(data[k].low),
          parseFloat(data[k].close)
        ]
      }));

      tradesRef.once("value", tradeSnap => {
        const trades = tradeSnap.val() || {};
        const annotations = [];

        for (let key in trades) {
          const t = trades[key];
          if (t.status !== "open") continue;

          // Entry line
          annotations.push({
            y: t.entry,
            borderColor: '#007bff',
            label: {
              borderColor: '#007bff',
              style: { color: '#fff', background: '#007bff' },
              text: `Entry ₹${t.entry}`
            }
          });

          // TP line
          if (t.tp) {
            annotations.push({
              y: t.tp,
              borderColor: '#28a745',
              label: {
                borderColor: '#28a745',
                style: { color: '#fff', background: '#28a745' },
                text: `TP ₹${t.tp}`
              }
            });
          }

          // SL line
          if (t.sl) {
            annotations.push({
              y: t.sl,
              borderColor: '#dc3545',
              label: {
                borderColor: '#dc3545',
                style: { color: '#fff', background: '#dc3545' },
                text: `SL ₹${t.sl}`
              }
            });
          }
        }

        const chartOptions = {
          chart: {
            type: 'candlestick',
            height: 400,
            animations: { enabled: false },
            toolbar: { autoSelected: 'pan', show: true },
            zoom: { enabled: true }
          },
          series: [{ data: candles }],
          xaxis: {
            type: 'category',
            labels: { show: false }
          },
          yaxis: {
            labels: {
              formatter: val => '₹' + val.toFixed(2)
            }
          },
          plotOptions: {
            candlestick: {
              colors: { upward: '#00B746', downward: '#EF403C' }
            }
          },
          annotations: { yaxis: annotations }
        };

        const chartDiv = document.querySelector("#chart");
        chartDiv.innerHTML = "";
        const chart = new ApexCharts(chartDiv, chartOptions);
        chart.render();
      });
    });
  }

  renderChart();
</script>




