<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JA Stock Trader</title>
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-database-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white">
  <div class="p-4 max-w-screen-md mx-auto">
    <h1 class="text-2xl font-bold mb-4">JA Stock Trader</h1>

    <div class="mb-4">
      <p>Welcome, <span id="usernameDisplay"></span></p>
      <p>Balance: ₹<span id="balanceDisplay">0</span></p>
    </div>

    <div class="grid grid-cols-2 gap-2 mb-4">
      <input id="quantity" type="number" placeholder="Quantity" class="p-2 text-black rounded">
      <input id="tp" type="number" placeholder="Take Profit ₹" class="p-2 text-black rounded">
      <input id="sl" type="number" placeholder="Stop Loss ₹" class="p-2 text-black rounded">
      <div class="flex space-x-2">
        <button onclick="placeTrade('buy')" class="bg-green-500 px-4 py-2 rounded">Buy</button>
        <button onclick="placeTrade('sell')" class="bg-red-500 px-4 py-2 rounded">Sell</button>
      </div>
    </div>

    <div id="chart" class="mb-6 h-64"></div>
    <p>Live Price: ₹<span id="livePrice">0</span></p>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Open Trades</h2>
      <div id="openTrades" class="space-y-2"></div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Withdrawal Request</h2>
      <input id="withdrawAmount" placeholder="Amount" class="p-2 text-black rounded mb-2 w-full">
      <input id="withdrawWhatsApp" placeholder="WhatsApp Number" class="p-2 text-black rounded mb-2 w-full">
      <button onclick="requestWithdrawal()" class="bg-blue-500 px-4 py-2 rounded">Request Withdrawal</button>
      <p class="text-yellow-400 text-sm mt-2">⚠️ ₹1 + 2% fee applies. Payout in 2 business days.</p>
    </div>

    <div>
      <h2 class="text-xl font-semibold mb-2">Trade History</h2>
      <div id="tradeHistory" class="space-y-2"></div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDV-E3ZJ0LPebK3yd19glE4aJOLqWOUdOg",
      authDomain: "brokerja-74512.firebaseapp.com",
      databaseURL: "https://brokerja-74512-default-rtdb.firebaseio.com",
      projectId: "brokerja-74512",
      storageBucket: "brokerja-74512.appspot.com",
      messagingSenderId: "293216906360",
      appId: "1:293216906360:web:3d5b489bf218979dd4a4c2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let username = localStorage.getItem('username');
    if (!username) username = prompt("Enter your username:");
    localStorage.setItem('username', username);
    document.getElementById("usernameDisplay").textContent = username;

    const chart = LightweightCharts.createChart(document.getElementById("chart"), {
      layout: { background: { color: '#111827' }, textColor: '#D1D5DB' },
      grid: { vertLines: { visible: true }, horzLines: { visible: true } },
      crosshair: { mode: 1 },
      rightPriceScale: { visible: true },
      timeScale: { visible: true, timeVisible: true, secondsVisible: true }
    });
    const candleSeries = chart.addCandlestickSeries();

    db.ref("chart").on("value", snapshot => {
      const data = snapshot.val() || [];
      candleSeries.setData(data);
      if (data.length > 0) {
        const last = data[data.length - 1];
        document.getElementById("livePrice").textContent = last.close.toFixed(2);
      }
    });

    function placeTrade(type) {
      const qty = parseInt(document.getElementById("quantity").value);
      const tp = parseFloat(document.getElementById("tp").value);
      const sl = parseFloat(document.getElementById("sl").value);
      const entry = parseFloat(document.getElementById("livePrice").textContent);

      if (!qty || qty <= 0 || !tp || !sl || !entry) return alert("Fill all fields correctly.");
      if ((type === 'buy' && (tp <= entry || sl >= entry)) || (type === 'sell' && (tp >= entry || sl <= entry))) {
        return alert("Invalid TP/SL levels for " + type.toUpperCase());
      }

      db.ref("users/" + username).once("value", snap => {
        const user = snap.val();
        const balance = user.balance || 0;
        if (balance < 5) return alert("Insufficient balance (min ₹5 required)");

        const tradeFee = 1;
        const newBal = balance - tradeFee;
        db.ref("users/" + username + "/balance").set(newBal);

        const trade = {
          type, qty, tp, sl, entry,
          open: true, time: Date.now()
        };
        db.ref("users/" + username + "/trades").push(trade);
      });
    }

    function loadTrades() {
      db.ref("users/" + username + "/trades").on("value", snap => {
        const data = snap.val() || {};
        const container = document.getElementById("openTrades");
        container.innerHTML = "";
        Object.entries(data).forEach(([id, trade]) => {
          if (!trade.open) return;
          const current = parseFloat(document.getElementById("livePrice").textContent);
          const pnl = ((trade.type === 'buy' ? 1 : -1) * (current - trade.entry) * trade.qty).toFixed(2);

          // Draw lines
          const now = Math.floor(Date.now() / 1000);
          const drawLine = (price, color) => {
            const line = chart.addLineSeries({ color, lineWidth: 1 });
            line.setData([{ time: now, value: price }]);
          };
          drawLine(trade.entry, '#00f');
          drawLine(trade.tp, '#0f0');
          drawLine(trade.sl, '#f00');

          const div = document.createElement("div");
          div.className = "bg-gray-800 p-2 rounded";
          div.innerHTML = `
            ${trade.type.toUpperCase()} ₹${trade.entry} x${trade.qty} |
            TP ₹${trade.tp} | SL ₹${trade.sl} |
            P&L: ₹${pnl}
            <button class="bg-yellow-500 ml-2 px-2 py-1 rounded" onclick="closeTrade('${id}')">Close</button>
          `;
          container.appendChild(div);
        });
      });
    }

    function closeTrade(id) {
      db.ref("users/" + username + "/trades/" + id + "/open").set(false);
    }

    function requestWithdrawal() {
      const amt = parseFloat(document.getElementById("withdrawAmount").value);
      const wa = document.getElementById("withdrawWhatsApp").value;
      if (!amt || !wa) return alert("Fill all fields");

      db.ref("withdrawals").push({
        user: username,
        amount: amt,
        whatsapp: wa,
        time: Date.now(),
        status: "pending"
      });
      alert("Request submitted.");
    }

    function loadTradeHistory() {
      db.ref("users/" + username + "/trades").on("value", snap => {
        const data = snap.val() || {};
        const history = document.getElementById("tradeHistory");
        history.innerHTML = "";
        Object.entries(data).forEach(([id, trade]) => {
          if (!trade.open) {
            const div = document.createElement("div");
            div.className = "bg-gray-700 p-2 rounded";
            div.innerText = `${trade.type.toUpperCase()} ₹${trade.entry} x${trade.qty} | TP ₹${trade.tp} | SL ₹${trade.sl}`;
            history.appendChild(div);
          }
        });
      });
    }

    db.ref("users/" + username + "/balance").on("value", snap => {
      document.getElementById("balanceDisplay").textContent = snap.val() || 0;
    });

    loadTrades();
    loadTradeHistory();
  </script>
</body>
</html>
