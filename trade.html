<!DOCTYPE html>
<html>
<head>
  <title>JA Stock Broker - Trade</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #0a0f1c;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    h2, h3 {
      margin-top: 20px;
    }
    input, button {
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
      border: none;
    }
    button {
      background: #007bff;
      color: white;
    }
    canvas {
      background: #fff;
      margin: 20px 0;
    }
    .trade-item {
      background: #1e1e2f;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h2>JA Stock Broker - Trade Panel</h2>
  <p>Balance: ₹<span id="balance">0.00</span></p>

  <label>Quantity:</label>
  <input type="number" id="quantity" value="1"><br>

  <label>TP:</label>
  <input type="number" id="tp"><br>

  <label>SL:</label>
  <input type="number" id="sl"><br>

  <button onclick="placeTrade('buy')">Buy</button>
  <button onclick="placeTrade('sell')">Sell</button>

  <p>Live PnL: ₹<span id="livePnl">0.00</span></p>

  <canvas id="chartCanvas" width="360" height="240"></canvas>

  <h3>Request Withdrawal</h3>
  <input type="number" id="withdrawAmount" placeholder="Amount">
  <input type="text" id="whatsapp" placeholder="WhatsApp Number">
  <button onclick="requestWithdrawal()">Request Withdrawal</button>
  <p style="color: orange">⚠️ 2% withdrawal fee applies on full capital.</p>

  <h3>Open Trades</h3>
  <div id="openTrades"></div>

  <h3>Trade History</h3>
  <div id="tradeHistory"></div>

  <script>
    const chartCanvas = document.getElementById('chartCanvas');
    const ctx = chartCanvas.getContext('2d');

    let user = 'demoUser'; // replace with dynamic login user
    let trades = [];

    function drawChart() {
      ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);

      trades.forEach((trade, i) => {
        const x = 20 + i * 30;
        const y = chartCanvas.height - trade.price * 10;
        ctx.fillStyle = trade.type === 'buy' ? 'green' : 'red';
        ctx.fillRect(x, y, 10, 10);

        // TP, SL, Entry lines
        ctx.strokeStyle = 'blue';
        ctx.beginPath();
        ctx.moveTo(x - 5, chartCanvas.height - trade.tp * 10);
        ctx.lineTo(x + 15, chartCanvas.height - trade.tp * 10);
        ctx.stroke();

        ctx.strokeStyle = 'orange';
        ctx.beginPath();
        ctx.moveTo(x - 5, chartCanvas.height - trade.sl * 10);
        ctx.lineTo(x + 15, chartCanvas.height - trade.sl * 10);
        ctx.stroke();
      });
    }

    function placeTrade(type) {
      const qty = parseInt(document.getElementById('quantity').value);
      const tp = parseFloat(document.getElementById('tp').value);
      const sl = parseFloat(document.getElementById('sl').value);
      const price = parseFloat(document.getElementById('balance').innerText); // simulate current price

      if ((type === 'buy' && (tp <= price || sl >= price)) ||
          (type === 'sell' && (tp >= price || sl <= price))) {
        alert('Invalid TP/SL based on direction.');
        return;
      }

      const trade = { type, qty, tp, sl, price };
      trades.push(trade);
      updateOpenTrades();
      drawChart();
    }

    function updateOpenTrades() {
      const container = document.getElementById('openTrades');
      container.innerHTML = '';
      trades.forEach((trade, i) => {
        const div = document.createElement('div');
        div.className = 'trade-item';
        div.innerHTML = `${trade.type.toUpperCase()} @ ₹${trade.price} | TP ₹${trade.tp} | SL ₹${trade.sl} 
        <button onclick="closeTrade(${i})">Close</button>`;
        container.appendChild(div);
      });
    }

    function closeTrade(index) {
      const trade = trades[index];
      // You can add PnL calculation here
      trades.splice(index, 1);
      updateOpenTrades();
      drawChart();
    }

    function requestWithdrawal() {
      alert('Withdrawal request sent. Will be processed in 2 business days.');
      document.getElementById('withdrawAmount').value = '';
      document.getElementById('whatsapp').value = '';
    }

    // Simulated balance
    document.getElementById('balance').innerText = '50.00';

    drawChart();
  </script>
</body>
</html>
