<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - JA Stock Broker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { background: #0d1117; color: white; font-family: sans-serif; padding: 20px; }
    input, button { margin: 5px 0; padding: 8px; font-size: 16px; }
    button { cursor: pointer; }
    .section { margin-top: 30px; }
    .card { background: #161b22; padding: 10px; margin: 5px 0; border-radius: 5px; }
    .card button { margin: 0 5px; }
  </style>
</head>
<body>
  <h2 id="clock"></h2>
  <button id="openMarket">‚úÖ Open Market</button>
  <button id="closeMarket">‚ùå Close Market</button>
  <button id="resetChart" style="background:red;color:white;">üóëÔ∏è Reset Chart</button>

  <div class="section">
    <h2>Market Chart</h2>
    <div id="chartContainer" style="height: 300px; border: 1px solid white; border-radius: 10px;"></div>
  </div>

  <div class="section">
    <h2>Manage Users</h2>
    <input id="username" placeholder="Username">
    <input id="password" placeholder="Password">
    <input id="balance" placeholder="Balance">
    <button onclick="addUser()">Add User</button>
    <button onclick="updateUser()">Update User</button>
    <button onclick="deleteUser()">Delete User</button>
  </div>

  <div class="section">
    <h2>Withdrawal Requests</h2>
    <h3>Pending</h3>
    <div id="pending"></div>
    <h3>Approved</h3>
    <div id="approved"></div>
    <h3>Rejected</h3>
    <div id="rejected"></div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "brokerja-74512.firebaseapp.com",
      databaseURL: "https://brokerja-74512-default-rtdb.firebaseio.com",
      projectId: "brokerja-74512",
      storageBucket: "brokerja-74512.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Clock
    setInterval(() => {
      document.getElementById('clock').textContent = new Date().toLocaleTimeString();
    }, 1000);

    // Chart
    const chart = LightweightCharts.createChart(document.getElementById('chartContainer'), {
      layout: { backgroundColor: '#0d1117', textColor: 'white' },
      grid: { vertLines: { color: '#444' }, horzLines: { color: '#444' } },
      rightPriceScale: { borderVisible: false },
      timeScale: { borderVisible: false }
    });
    const candleSeries = chart.addCandlestickSeries();

    db.ref("chart").on("value", snap => {
      const data = [];
      snap.forEach(child => {
        const d = child.val();
        data.push({ time: d.t, open: d.o, high: d.h, low: d.l, close: d.c });
      });
      candleSeries.setData(data);
    });

    // Market Controls
    document.getElementById('openMarket').onclick = () => db.ref("market").set(true);
    document.getElementById('closeMarket').onclick = () => db.ref("market").set(false);
    document.getElementById('resetChart').onclick = () => db.ref("chart").remove();

    // User Management
    function addUser() {
      const u = username.value, p = password.value, b = +balance.value;
      db.ref("users/" + u).set({ password: p, balance: b });
    }
    function updateUser() {
      const u = username.value, p = password.value, b = +balance.value;
      db.ref("users/" + u).update({ password: p, balance: b });
    }
    function deleteUser() {
      const u = username.value;
      db.ref("users/" + u).remove();
    }

    // Withdrawal Requests
    const renderWithdrawals = () => {
      ['pending', 'approved', 'rejected'].forEach(status => {
        db.ref('withdrawals/' + status).on('value', snap => {
          const container = document.getElementById(status);
          container.innerHTML = '';
          snap.forEach(child => {
            const d = child.val();
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `<b>${d.name}</b><br>‚Çπ${d.amount} | ${d.whatsapp}<br>${d.time}<br>` +
              (status === 'pending' ? `<button onclick="approve('${child.key}', ${d.amount}, '${d.user}')">‚úÖ Approve</button><button onclick="reject('${child.key}')">‚ùå Reject</button>` : '');
            container.appendChild(div);
          });
        });
      });
    }
    renderWithdrawals();

    function approve(id, amount, user) {
      db.ref('withdrawals/pending/' + id).once('value').then(snap => {
        db.ref('withdrawals/approved/' + id).set(snap.val());
        db.ref('withdrawals/pending/' + id).remove();
        db.ref('users/' + user + '/balance').once('value').then(balSnap => {
          const newBal = balSnap.val() - amount;
          db.ref('users/' + user).update({ balance: newBal });
        });
      });
    }

    function reject(id) {
      db.ref('withdrawals/pending/' + id).once('value').then(snap => {
        db.ref('withdrawals/rejected/' + id).set(snap.val());
        db.ref('withdrawals/pending/' + id).remove();
      });
    }
  </script>
</body>
</html>
