<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JA Admin Panel</title>
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-database-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white p-4">
  <h1 class="text-2xl font-bold mb-4">JA Admin Panel</h1>

  <div class="grid grid-cols-3 gap-4 mb-6">
    <div>
      <label>Open</label><input id="open" type="number" class="text-black w-full">
      <label>High</label><input id="high" type="number" class="text-black w-full">
      <label>Low</label><input id="low" type="number" class="text-black w-full">
      <label>Close</label><input id="close" type="number" class="text-black w-full">
      <button onclick="addCandle()" class="bg-green-600 w-full mt-2 p-2 rounded">Add Candle</button>
    </div>
    <div>
      <button onclick="toggleMarket()" class="bg-blue-600 w-full p-2 rounded mb-2">Toggle Market Open/Close</button>
      <button onclick="resetChart()" class="bg-red-600 w-full p-2 rounded">Reset Chart</button>
      <p class="mt-4">Market: <span id="marketStatus">Checking...</span></p>
    </div>
    <div>
      <h2 class="font-semibold">Update User</h2>
      <input id="editUser" placeholder="Username" class="text-black w-full">
      <input id="editBalance" type="number" placeholder="New Balance" class="text-black w-full">
      <button onclick="updateBalance()" class="bg-yellow-600 w-full p-2 rounded mt-2">Update Balance</button>
      <button onclick="deleteUser()" class="bg-red-700 w-full p-2 rounded mt-2">Delete User</button>
    </div>
  </div>

  <div id="chart" class="h-64 mb-8"></div>

  <div class="grid grid-cols-3 gap-6">
    <div>
      <h2 class="text-xl mb-2">Pending Withdrawals</h2>
      <div id="pendingWithdrawals" class="space-y-2"></div>
    </div>
    <div>
      <h2 class="text-xl mb-2">Approved</h2>
      <div id="approvedWithdrawals" class="space-y-2"></div>
    </div>
    <div>
      <h2 class="text-xl mb-2">Rejected</h2>
      <div id="rejectedWithdrawals" class="space-y-2"></div>
    </div>
  </div>

  <script>
    const config = {
      apiKey: "AIzaSyDV-E3ZJ0LPebK3yd19glE4aJOLqWOUdOg",
      authDomain: "brokerja-74512.firebaseapp.com",
      databaseURL: "https://brokerja-74512-default-rtdb.firebaseio.com",
      projectId: "brokerja-74512",
      storageBucket: "brokerja-74512.appspot.com",
      messagingSenderId: "293216906360",
      appId: "1:293216906360:web:3d5b489bf218979dd4a4c2"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    const marketRef = db.ref("market/isOpen");
    const chartRef = db.ref("chart");

    let chart = LightweightCharts.createChart(document.getElementById("chart"), {
      layout: { background: { color: '#111827' }, textColor: '#D1D5DB' },
      rightPriceScale: { visible: true },
      timeScale: { visible: true, timeVisible: true },
    });
    const candleSeries = chart.addCandlestickSeries();

    chartRef.on("value", snap => {
      const candles = snap.val() || [];
      candleSeries.setData(candles);
    });

    function addCandle() {
      const open = parseFloat(document.getElementById("open").value);
      const high = parseFloat(document.getElementById("high").value);
      const low = parseFloat(document.getElementById("low").value);
      const close = parseFloat(document.getElementById("close").value);
      const timestamp = Math.floor(Date.now() / 1000);
      chartRef.once("value", snap => {
        const data = snap.val() || [];
        data.push({ time: timestamp, open, high, low, close });
        chartRef.set(data);
      });
    }

    function resetChart() {
      chartRef.set([]);
    }

    function toggleMarket() {
      marketRef.once("value", snap => {
        marketRef.set(!snap.val());
      });
    }

    marketRef.on("value", snap => {
      document.getElementById("marketStatus").textContent = snap.val() ? "âœ… Open" : "âŒ Closed";
    });

    function updateBalance() {
      const user = document.getElementById("editUser").value;
      const balance = parseFloat(document.getElementById("editBalance").value);
      if (!user || isNaN(balance)) return alert("Enter valid user and balance");
      db.ref("users/" + user + "/balance").set(balance);
    }

    function deleteUser() {
      const user = document.getElementById("editUser").value;
      if (!user) return;
      if (confirm("Delete user " + user + "?")) {
        db.ref("users/" + user).remove();
      }
    }

    db.ref("withdrawals").on("value", snap => {
      const data = snap.val() || {};
      const pending = document.getElementById("pendingWithdrawals");
      const approved = document.getElementById("approvedWithdrawals");
      const rejected = document.getElementById("rejectedWithdrawals");
      pending.innerHTML = approved.innerHTML = rejected.innerHTML = "";

      Object.entries(data).forEach(([id, w]) => {
        const div = document.createElement("div");
        div.className = "bg-gray-800 p-2 rounded";
        div.innerHTML = `${w.user} â‚¹${w.amount}<br>ðŸ“² ${w.whatsapp}`;
        if (w.status === "pending") {
          const approveBtn = document.createElement("button");
          approveBtn.textContent = "âœ… Approve";
          approveBtn.className = "bg-green-600 px-2 py-1 rounded mr-2";
          approveBtn.onclick = () => db.ref("withdrawals/" + id + "/status").set("approved");

          const rejectBtn = document.createElement("button");
          rejectBtn.textContent = "âŒ Reject";
          rejectBtn.className = "bg-red-600 px-2 py-1 rounded";
          rejectBtn.onclick = () => db.ref("withdrawals/" + id + "/status").set("rejected");

          div.appendChild(approveBtn);
          div.appendChild(rejectBtn);
          pending.appendChild(div);
        } else if (w.status === "approved") {
          approved.appendChild(div);
        } else if (w.status === "rejected") {
          rejected.appendChild(div);
        }
      });
    });
  </script>
</body>
</html>
