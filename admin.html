<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JA Admin Panel</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { background: #0e1217; color: white; font-family: Arial; padding: 20px; }
    input, button { padding: 6px 10px; margin: 5px; border-radius: 4px; }
    #chart { background: white; border-radius: 10px; margin-top: 20px; }
    .btn { padding: 10px 15px; border: none; border-radius: 6px; margin: 5px; font-weight: bold; cursor: pointer; }
    .green { background: #28a745; color: white; }
    .red { background: #dc3545; color: white; }
    .section { margin-top: 30px; }
    .card { background: #1c1f24; padding: 10px; margin: 10px 0; border-radius: 8px; }
  </style>
</head>
<body>
  <h2 id="time"></h2>
  <button class="btn green" onclick="setMarket(true)">‚úÖ Open Market</button>
  <button class="btn red" onclick="setMarket(false)">‚ùå Close Market</button>
  <button class="btn red" onclick="resetChart()">üóëÔ∏è Reset Chart</button>

  <div class="section">
    <h2>Market Chart</h2>
    <div id="chart" style="height:400px;"></div>
  </div>

  <div class="section">
    <h2>Manage Users</h2>
    <input id="uname" placeholder="Username">
    <input id="upass" placeholder="Password">
    <input id="ubal" placeholder="Balance">
    <button onclick="addUser()">Add User</button>
    <button onclick="updateUser()">Update User</button>
  </div>

  <div class="section">
    <h2>Withdrawal Requests</h2>
    <h3>Pending</h3>
    <div id="withdrawPending"></div>
    <h3>Approved</h3>
    <div id="withdrawApproved"></div>
    <h3>Rejected</h3>
    <div id="withdrawRejected"></div>
  </div>

  <script>
    const config = {
      apiKey: "AIzaSyAr63v10I56cCghOTrGV_KhjQ69HnyaP3Q",
      authDomain: "brokerja-74512.firebaseapp.com",
      databaseURL: "https://brokerja-74512-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "brokerja-74512",
      storageBucket: "brokerja-74512.appspot.com",
      messagingSenderId: "1048821297447",
      appId: "1:1048821297447:web:b8a1e2c43b8ed8333b3902"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    function setMarket(state) {
      db.ref("market/isOpen").set(state);
      alert("Market " + (state ? "opened" : "closed"));
    }

    function resetChart() {
      if (confirm("Reset entire chart?")) db.ref("market/chart").remove();
    }

    setInterval(() => {
      const now = new Date();
      document.getElementById("time").innerText = now.toLocaleTimeString();
    }, 1000);

    db.ref("market/chart").on("value", snap => {
      const data = snap.val();
      const candles = [];
      let i = 0;
      for (let k in data) {
        const c = data[k];
        candles.push({ x: i++, y: [c.open, c.high, c.low, c.close] });
      }
      const lastCandle = candles[candles.length - 1];
      const annotation = lastCandle ? {
        y: lastCandle.y[3],
        borderColor: '#ff0',
        label: { text: 'Last Candle', style: { color: '#000' }, borderColor: '#ff0' }
      } : null;
      const options = {
        chart: { type: 'candlestick', height: 400 },
        series: [{ data: candles }],
        xaxis: { type: 'category' },
        yaxis: { labels: { formatter: v => '‚Çπ' + v.toFixed(2) } },
        annotations: { yaxis: annotation ? [annotation] : [] }
      };
      if (!window.chart) {
        window.chart = new ApexCharts(document.getElementById("chart"), options);
        window.chart.render();
      } else {
        window.chart.updateSeries([{ data: candles }]);
        window.chart.updateOptions({ annotations: { yaxis: annotation ? [annotation] : [] } });
      }
    });

    function addUser() {
      const u = document.getElementById("uname").value;
      const p = document.getElementById("upass").value;
      const b = parseFloat(document.getElementById("ubal").value);
      if (!u || !p || isNaN(b)) return alert("Fill all fields");
      db.ref("users/" + u).set({ password: p, balance: b });
      alert("User added ‚úÖ");
    }

    function updateUser() {
      const u = document.getElementById("uname").value;
      const p = document.getElementById("upass").value;
      const b = parseFloat(document.getElementById("ubal").value);
      if (!u || (!p && isNaN(b))) return alert("Enter username and at least one field to update");
      if (p) db.ref("users/" + u + "/password").set(p);
      if (!isNaN(b)) db.ref("users/" + u + "/balance").set(b);
      alert("User updated ‚úÖ");
    }

    db.ref("users").once("value", snap => {
      const users = snap.val();
      for (let uname in users) {
        const ref = db.ref("users/" + uname + "/trades");
        ref.on("value", tSnap => {
          const trades = tSnap.val();
          for (let id in trades) {
            const t = trades[id];
            if (t.status === "open") {
              db.ref("users/" + uname + "/balance").once("value", bSnap => {
                const bal = parseFloat(bSnap.val());
                if (bal < 5) {
                  const pnl = (t.type === "buy" ? (t.entry - t.entry) : (t.entry - t.entry)) * t.qty;
                  ref.child(id).update({ status: "closed", pnl });
                }
              });
            }
          }
        });
      }
    });

    db.ref("users").on("value", snap => {
      const users = snap.val();
      document.getElementById("withdrawPending").innerHTML = "";
      document.getElementById("withdrawApproved").innerHTML = "";
      document.getElementById("withdrawRejected").innerHTML = "";

      for (let uname in users) {
        const w = users[uname].withdrawalRequests;
        if (!w) continue;
        for (let id in w) {
          const r = w[id];
          const el = document.createElement("div");
          el.className = "card";
          el.innerHTML = `
            <b>${uname}</b><br>‚Çπ${r.amount} | ${r.contact}<br>
            ${new Date(r.timestamp).toLocaleString()}<br>
            <button onclick="approve('${uname}','${id}')">‚úÖ Approve</button>
            <button onclick="reject('${uname}','${id}')">‚ùå Reject</button>
          `;
          if (r.status === "pending") document.getElementById("withdrawPending").appendChild(el);
          if (r.status === "approved") document.getElementById("withdrawApproved").appendChild(el);
          if (r.status === "rejected") document.getElementById("withdrawRejected").appendChild(el);
        }
      }
    });

    function approve(user, id) {
      db.ref(`users/${user}/withdrawalRequests/${id}/status`).set("approved");
    }

    function reject(user, id) {
      db.ref(`users/${user}/withdrawalRequests/${id}/status`).set("rejected");
    }
  </script>
</body>
</html>
