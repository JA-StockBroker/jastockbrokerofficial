<!DOCTYPE html>
<html>
<head>
  <title>JA Stock Broker - Admin Panel</title>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #0d1117;
      color: white;
      font-family: Arial, sans-serif;
      padding: 10px;
    }
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      margin: 2px;
    }
    .btn-green { background: green; color: white; }
    .btn-red { background: red; color: white; }
    .btn-blue { background: #007bff; color: white; }
    #chart {
      height: 300px;
    }
    .user-card, .withdrawal-card {
      background: #1c1c1c;
      margin: 6px 0;
      padding: 8px;
      border-radius: 5px;
    }
    input {
      margin: 4px;
      padding: 6px;
      border-radius: 5px;
      border: none;
    }
    h2 { margin-top: 30px; }
  </style>
</head>
<body>
  <div id="clock"></div>
  <h2>Admin Panel</h2>
  <div>
    <button id="openMarket" class="btn-green">Open Market</button>
    <button id="closeMarket" class="btn-red">Close Market</button>
    <button id="resetChart" class="btn-red">Reset Chart</button>
  </div>
  <p>Live Price: <span id="livePrice">Loading...</span></p>
  <input id="adminQty" type="number" value="1" style="width: 60px"> 
  <button class="btn-blue" onclick="adminBuy()">Buy</button>
  <button class="btn-blue" onclick="adminSell()">Sell</button>
  <div id="chart"></div>

  <h2>Users</h2>
  <input id="newUsername" placeholder="Username">
  <input id="newPassword" placeholder="Password">
  <input id="newBalance" type="number" placeholder="Balance">
  <button class="btn-blue" onclick="addUser()">Add User</button>
  <button class="btn-blue" onclick="updateUser()">Update User</button>
  <div id="userList"></div>

  <h2>Withdrawals</h2>
  <h3>Pending</h3>
  <div id="pendingWithdrawals"></div>
  <h3>Approved</h3>
  <div id="approvedWithdrawals"></div>
  <h3>Rejected</h3>
  <div id="rejectedWithdrawals"></div>

  <script>
    const firebaseConfig = {
      databaseURL: "https://brokerja-74512-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const chart = LightweightCharts.createChart(document.getElementById("chart"), {
      layout: { background: { color: '#0d1117' }, textColor: 'white' },
      grid: { vertLines: { color: '#444' }, horzLines: { color: '#444' } },
      rightPriceScale: { borderVisible: false },
      timeScale: { timeVisible: false, secondsVisible: false },
    });
    const candleSeries = chart.addCandlestickSeries();

    function updateClock() {
      document.getElementById("clock").innerText = new Date().toLocaleTimeString();
    }
    setInterval(updateClock, 1000);
    updateClock();

    const chartRef = db.ref("chart");
    chartRef.on("value", (snapshot) => {
      const data = snapshot.val() || [];
      candleSeries.setData(data);
      if (data.length > 0) {
        const last = data[data.length - 1];
        document.getElementById("livePrice").innerText = `₹${last.close.toFixed(2)}`;
      }
    });

    function addCandle(type) {
      chartRef.once("value").then(snap => {
        const candles = snap.val() || [];
        const last = candles[candles.length - 1] || { close: 1 };
        const qty = parseFloat(document.getElementById("adminQty").value) || 1;
        const newPrice = type === "buy" ? last.close + qty * 0.1 : last.close - qty * 0.1;
        const candle = {
          time: Math.floor(Date.now() / 1000),
          open: last.close,
          high: Math.max(last.close, newPrice),
          low: Math.min(last.close, newPrice),
          close: newPrice
        };
        candles.push(candle);
        chartRef.set(candles);
        db.ref("price").set(newPrice);
      });
    }
    function adminBuy() { addCandle("buy"); }
    function adminSell() { addCandle("sell"); }

    document.getElementById("openMarket").onclick = () => db.ref("market").set("open");
    document.getElementById("closeMarket").onclick = () => db.ref("market").set("closed");
    document.getElementById("resetChart").onclick = () => {
      chartRef.set([]);
      db.ref("price").set(1);
    };

    function addUser() {
      const uname = newUsername.value;
      const pass = newPassword.value;
      const bal = parseFloat(newBalance.value);
      db.ref("users/" + uname).set({ password: pass, balance: bal });
    }

    function updateUser() {
      const uname = newUsername.value;
      const pass = newPassword.value;
      const bal = parseFloat(newBalance.value);
      db.ref("users/" + uname).update({ password: pass, balance: bal });
    }

    function deleteUser(username) {
      db.ref("users/" + username).remove();
    }

    db.ref("users").on("value", snap => {
      const users = snap.val() || {};
      userList.innerHTML = Object.entries(users).map(([u, data]) => `
        <div class='user-card'>
          <b>${u}</b> Balance: ₹${data.balance}<br>
          <button class='btn-blue' onclick="edit('${u}', '${data.password}', ${data.balance})">Edit</button>
          <button class='btn-red' onclick="deleteUser('${u}')">Delete</button>
        </div>`).join('');
    });

    function edit(u, p, b) {
      newUsername.value = u;
      newPassword.value = p;
      newBalance.value = b;
    }

    function handleWithdrawals() {
      db.ref("withdrawals").on("value", snap => {
        const data = snap.val() || {};
        const pending = [], approved = [], rejected = [];
        Object.entries(data).forEach(([id, w]) => {
          const card = `
            <div class='withdrawal-card'>
              <b>${w.username}</b> ₹${w.amount} | ${w.whatsapp || 'undefined'}<br>${new Date(w.time).toLocaleString()}<br>
              <button class='btn-green' onclick="db.ref('withdrawals/${id}/status').set('approved')">Approve</button>
              <button class='btn-red' onclick="db.ref('withdrawals/${id}/status').set('rejected')">Reject</button>
            </div>`;
          if (w.status === 'approved') approved.push(card);
          else if (w.status === 'rejected') rejected.push(card);
          else pending.push(card);
        });
        pendingWithdrawals.innerHTML = pending.join('');
        approvedWithdrawals.innerHTML = approved.join('');
        rejectedWithdrawals.innerHTML = rejected.join('');
      });
    }
    handleWithdrawals();
  </script>
</body>
</html>
