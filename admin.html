<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JA Stock Broker Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { background: #0f172a; color: white; font-family: Arial, sans-serif; padding: 20px; }
    input, button { padding: 6px 10px; margin: 5px; }
    #chart { background: white; border-radius: 10px; margin-top: 20px; height: 400px; }
    .user-card { background: #1e293b; padding: 10px; margin: 10px 0; border-radius: 6px; }
    .section { margin-top: 30px; }
    .withdrawal-card { background: #334155; padding: 8px; margin: 5px 0; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Admin Panel</h1>

  <button onclick="openMarket()">Open Market</button>
  <button onclick="closeMarket()">Close Market</button>
  <button onclick="resetChart()">Reset Chart</button>

  <p>Live Price: ‚Çπ<span id="livePrice">--</span></p>
  <input type="number" id="qty" placeholder="Qty" value="1" min="1">
  <button onclick="simulateCandle('buy')">‚¨Ü Buy</button>
  <button onclick="simulateCandle('sell')">‚¨á Sell</button>

  <div id="chart"></div>

  <div class="section">
    <h2>Users</h2>
    <input id="newUser" placeholder="Username">
    <input id="newPass" placeholder="Password">
    <input id="newBal" type="number" placeholder="Balance">
    <button onclick="addUser()">Add User</button>
    <div id="userList"></div>
  </div>

  <div class="section">
    <h2>Withdrawals</h2>
    <h3>Pending</h3>
    <div id="pendingWithdrawals"></div>
    <h3>Approved</h3>
    <div id="approvedWithdrawals"></div>
    <h3>Rejected</h3>
    <div id="rejectedWithdrawals"></div>
  </div>

  <script>
    const config = {
      apiKey: "AIzaSyAr63v10I56cCghOTrGV_KhjQ69HnyaP3Q",
      authDomain: "brokerja-74512.firebaseapp.com",
      databaseURL: "https://brokerja-74512-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "brokerja-74512",
      storageBucket: "brokerja-74512.appspot.com",
      messagingSenderId: "1048821297447",
      appId: "1:1048821297447:web:b8a1e2c43b8ed8333b3902"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    const chartRef = db.ref("market/chart");
    const priceRef = db.ref("market/currentPrice");
    const usersRef = db.ref("users");
    const marketRef = db.ref("market/isOpen");

    let currentPrice = 1.0;

    priceRef.on("value", snap => {
      currentPrice = parseFloat(snap.val() || 1);
      document.getElementById("livePrice").innerText = currentPrice.toFixed(2);
    });

    function simulateCandle(type) {
      const qty = parseInt(document.getElementById("qty").value);
      const move = qty * 0.10;
      const open = currentPrice;
      const close = type === "buy" ? open + move : open - move;
      const high = Math.max(open, close);
      const low = Math.min(open, close);
      const candle = { open, high, low, close, timestamp: Date.now() };
      chartRef.push(candle);
      priceRef.set(close);
    }

    function openMarket() {
      marketRef.set(true);
      alert("Market Opened ‚úÖ");
    }

    function closeMarket() {
      marketRef.set(false);
      alert("Market Closed ‚ùå");
    }

    function resetChart() {
      chartRef.remove();
      priceRef.set(1);
      alert("Chart Reset üîÑ");
    }

    function addUser() {
      const u = document.getElementById("newUser").value;
      const p = document.getElementById("newPass").value;
      const b = parseFloat(document.getElementById("newBal").value);
      if (!u || !p || isNaN(b)) return alert("Fill all fields");
      db.ref("users/" + u).set({ password: p, balance: b });
    }

    usersRef.on("value", snap => {
      const users = snap.val();
      const list = document.getElementById("userList");
      list.innerHTML = "";
      for (let u in users) {
        const d = users[u];
        const div = document.createElement("div");
        div.className = "user-card";
        div.innerHTML = `
          <strong>${u}</strong><br>
          Balance: ‚Çπ${d.balance} <br>
          <button onclick="editUser('${u}', ${d.balance})">‚úèÔ∏è Edit</button>
          <button onclick="deleteUser('${u}')">üóë Delete</button>
        `;
        list.appendChild(div);
      }
    });

    function editUser(username, oldBal) {
      const newBal = prompt("Enter new balance", oldBal);
      if (newBal !== null) db.ref("users/" + username + "/balance").set(parseFloat(newBal));
    }

    function deleteUser(username) {
      if (confirm("Delete user " + username + "?")) db.ref("users/" + username).remove();
    }

    const withdrawBox = {
      pending: document.getElementById("pendingWithdrawals"),
      approved: document.getElementById("approvedWithdrawals"),
      rejected: document.getElementById("rejectedWithdrawals")
    };

    usersRef.on("value", snap => {
      const users = snap.val();
      for (let u in users) {
        const wds = users[u].withdrawalRequests || {};
        for (let key in wds) {
          const req = wds[key];
          const box = withdrawBox[req.status];
          const div = document.createElement("div");
          div.className = "withdrawal-card";
          div.innerHTML = `
            <strong>${u}</strong> ‚Çπ${req.amount} | ${req.contact}<br>
            <button onclick="updateWithdrawal('${u}','${key}','approved')">‚úÖ Approve</button>
            <button onclick="updateWithdrawal('${u}','${key}','rejected')">‚ùå Reject</button>
          `;
          box.appendChild(div);
        }
      }
    });

    function updateWithdrawal(user, key, status) {
      db.ref(`users/${user}/withdrawalRequests/${key}/status`).set(status);
    }

    chartRef.on("value", snap => {
  const data = snap.val();
  const allCandles = Object.values(data || {});

  const formatted = allCandles.map(c => ({
    x: new Date(c.timestamp),
    y: [c.open, c.high, c.low, c.close]
  }));

  const chart = new ApexCharts(document.getElementById("chart"), {
    chart: {
      type: 'candlestick',
      toolbar: {
        show: true,
        tools: {
          pan: true,
          zoom: true,
          zoomin: true,
          zoomout: true,
          reset: true
        }
      },
      zoom: {
        enabled: true,
        type: 'x',
        autoScaleYaxis: true
      },
      animations: { enabled: false }
    },
    series: [{ data: formatted }],
    xaxis: {
      type: 'datetime',
      labels: { show: true }
    },
    yaxis: {
      labels: { formatter: v => '‚Çπ' + v.toFixed(2) }
    }
  });

  document.getElementById("chart").innerHTML = ""; // Clear previous chart
  chart.render();
});
  </script>
</body>
</html>

