<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JA Stock Broker Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { background: #0f172a; color: white; font-family: Arial, sans-serif; padding: 20px; }
    input, button { padding: 6px 10px; margin: 5px; }
    #chart { background: white; border-radius: 10px; margin-top: 20px; height: 500px; }
    .user-card { background: #1e293b; padding: 10px; margin: 10px 0; border-radius: 6px; }
    .section { margin-top: 30px; }
    .withdrawal-card { background: #334155; padding: 8px; margin: 5px 0; border-radius: 6px; }
    #fullscreenBtn { float: right; margin-top: -40px; }
  </style>
</head>
<body>
  <h1>Admin Panel</h1>
  <button onclick="openMarket()">Open Market</button>
  <button onclick="closeMarket()">Close Market</button>
  <button onclick="resetChart()">Reset Chart</button>
  <button id="fullscreenBtn" onclick="toggleFullScreen()">ðŸ”³ Fullscreen</button>

  <p>Live Price: â‚¹<span id="livePrice">--</span></p>
  <input type="number" id="qty" placeholder="Qty" value="1" min="1">
  <button onclick="simulateCandle('buy')">â¬† Buy</button>
  <button onclick="simulateCandle('sell')">â¬‡ Sell</button>

  <div id="chart"></div>

  <!-- User and Withdrawals sections will go below this -->

  <script>
    const config = {
      apiKey: "AIzaSyAr63v10I56cCghOTrGV_KhjQ69HnyaP3Q",
      authDomain: "brokerja-74512.firebaseapp.com",
      databaseURL: "https://brokerja-74512-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "brokerja-74512",
      storageBucket: "brokerja-74512.appspot.com",
      messagingSenderId: "1048821297447",
      appId: "1:1048821297447:web:b8a1e2c43b8ed8333b3902"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    const chartRef = db.ref("market/chart");
    const priceRef = db.ref("market/currentPrice");
    const marketRef = db.ref("market/isOpen");

    let currentPrice = 1.0;
    let chart;

    priceRef.on("value", snap => {
      currentPrice = parseFloat(snap.val() || 1);
      document.getElementById("livePrice").innerText = currentPrice.toFixed(2);
    });

    function simulateCandle(type) {
      const qty = parseInt(document.getElementById("qty").value);
      const move = qty * 0.10;
      const open = currentPrice;
      const close = type === "buy" ? open + move : open - move;
      const high = Math.max(open, close);
      const low = Math.min(open, close);
      const candle = { open, high, low, close, timestamp: Date.now() };
      chartRef.push(candle);
      priceRef.set(close);
    }

    function openMarket() {
      marketRef.set(true);
      alert("Market Opened âœ…");
    }

    function closeMarket() {
      marketRef.set(false);
      alert("Market Closed âŒ");
    }

    function resetChart() {
      chartRef.remove();
      priceRef.set(1);
      alert("Chart Reset ðŸ”„");
    }

    function toggleFullScreen() {
      const chartDiv = document.getElementById("chart");
      if (!document.fullscreenElement) {
        chartDiv.requestFullscreen().catch(err => alert("Error: " + err));
      } else {
        document.exitFullscreen();
      }
    }

    chartRef.on("value", snap => {
      const data = snap.val() || {};
      const allCandles = Object.values(data);

      const formatted = allCandles.map(c => ({
        x: new Date(c.timestamp),
        y: [c.open, c.high, c.low, c.close]
      }));

      const options = {
        chart: {
          type: 'candlestick',
          height: 500,
          animations: { enabled: false },
          toolbar: { show: true, tools: { zoom: true, pan: true } },
          zoom: { enabled: true },
          pan: { enabled: true, type: "xy", autoScaleYaxis: true },
        },
        series: [{ data: formatted }],
        xaxis: {
          type: 'datetime',
          labels: { show: true },
        },
        yaxis: {
          labels: { formatter: val => 'â‚¹' + val.toFixed(2) }
        }
      };

      const chartDiv = document.getElementById("chart");
      chartDiv.innerHTML = "";
      chart = new ApexCharts(chartDiv, options);
      chart.render();
    });
  </script>
</body>
</html>
